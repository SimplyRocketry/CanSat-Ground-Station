<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rocket Telemetry Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 { margin: 20px; }
    #controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    button:hover { background: #1976d2; }
    #dataGrid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      width: 90%;
      max-width: 600px;
    }
    .card {
      background: #222;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .label { font-size: 14px; color: #aaa; }
    .value { font-size: 20px; font-weight: bold; margin-top: 5px; color: #4caf50; }
  </style>
</head>
<body>
  <h1>Rocket Telemetry Dashboard</h1>

  <div id="controls">
    <button id="serialBtn">Connect Serial</button>
    <button id="bleBtn">Connect BLE</button>
    <button id="disconnectBtn">Disconnect</button>
  </div>
  
  <div id="dataGrid">
    <div class="card"><div class="label">Mission Time</div><div id="time" class="value">--</div></div>
    <div class="card"><div class="label">Packets Sent</div><div id="packets" class="value">--</div></div>
    <div class="card"><div class="label">State</div><div id="state" class="value">--</div></div>
    <div class="card"><div class="label">Altitude (m)</div><div id="altitude" class="value">--</div></div>
    <div class="card"><div class="label">Velocity (m/s)</div><div id="velocity" class="value">--</div></div>
    <div class="card"><div class="label">Latitude</div><div id="lat" class="value">--</div></div>
    <div class="card"><div class="label">Longitude</div><div id="lon" class="value">--</div></div>
    <div class="card"><div class="label">GPS Sats</div><div id="sats" class="value">--</div></div>
  </div>

  <script>
    let bleDevice, bleCharacteristic;
    let serialPort, serialReader;

    // Update dashboard with parsed telemetry
    function updateDashboard(line) {
      const parts = line.split(",").map(p => p.trim());
      if (parts.length >= 9) {
        document.getElementById("time").textContent = parts[1];
        document.getElementById("packets").textContent = parts[2];
        if (parts[3] == 0){
            document.getElementById("state").textContent = "Pad Idle";
        } else if (parts[3] == 1){
            document.getElementById("state").textContent = "Ascent";
        } else if (parts[3] == 2){
            document.getElementById("state").textContent = "Falling under drogue";
        } else if (parts[3] == 3){
            document.getElementById("state").textContent = "Falling under main";
        }
        document.getElementById("altitude").textContent = parts[4];
        document.getElementById("velocity").textContent = parts[5];
        document.getElementById("lat").textContent = parts[6];
        document.getElementById("lon").textContent = parts[7];
        document.getElementById("sats").textContent = parts[8];
      }
    }

    // --------------------
    // Serial Mode
    // --------------------
    document.getElementById("serialBtn").addEventListener("click", async () => {
      try {
        serialPort = await navigator.serial.requestPort();
        await serialPort.open({ baudRate: 115200 });
        const decoder = new TextDecoderStream();
        serialPort.readable.pipeTo(decoder.writable);
        serialReader = decoder.readable.getReader();

        alert("Serial connected!");
        (async function readLoop() {
          while (true) {
            const { value, done } = await serialReader.read();
            if (done) break;
            if (value) {
              const lines = value.split("\n");
              lines.forEach(line => { if (line.trim().length > 0) updateDashboard(line); });
            }
          }
        })();
      } catch (err) {
        console.error("Serial connection failed", err);
      }
    });

    // --------------------
    // BLE Mode
    // --------------------
    document.getElementById("bleBtn").addEventListener("click", async () => {
      try {
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: "ESP32" }], // Adjust to your device name
          optionalServices: [0xFFE0]          // Replace with your UART service UUID
        });
        const server = await bleDevice.gatt.connect();
        const service = await server.getPrimaryService(0xFFE0);
        bleCharacteristic = await service.getCharacteristic(0xFFE1);

        await bleCharacteristic.startNotifications();
        bleCharacteristic.addEventListener("characteristicvaluechanged", (event) => {
          const value = new TextDecoder("utf-8").decode(event.target.value).trim();
          if (value.length > 0) updateDashboard(value);
        });

        alert("BLE connected!");
      } catch (err) {
        console.error("BLE connection failed", err);
      }
    });

    // --------------------
    // Disconnect
    // --------------------
    document.getElementById("disconnectBtn").addEventListener("click", async () => {
      try {
        // Close serial if active
        if (serialReader) {
          await serialReader.cancel();
          serialReader.releaseLock();
          serialReader = null;
        }
        if (serialPort) {
          await serialPort.close();
          serialPort = null;
        }

        // Disconnect BLE if active
        if (bleCharacteristic) {
          await bleCharacteristic.stopNotifications();
          bleCharacteristic = null;
        }
        if (bleDevice && bleDevice.gatt.connected) {
          bleDevice.gatt.disconnect();
          bleDevice = null;
        }

        alert("Disconnected!");
      } catch (err) {
        console.error("Disconnect failed", err);
      }
    });
  </script>
</body>
</html>
